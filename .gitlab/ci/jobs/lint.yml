# ============================================
# Terraform Lint Jobs
# ============================================
# Runs tflint and terraform fmt to check code quality
# ============================================

.terraform_lint_job:
  extends: .terraform_base
  tags:
    - default
  script:
    - |
      set -euo pipefail
      
      echo "=========================================="
      echo "Running Terraform lint for $TARGET"
      echo "=========================================="
      
      # Terraform fmt check
      echo "Running terraform fmt -check..."
      terraform fmt -check -recursive -diff || {
        echo "ERROR: terraform fmt check failed"
        echo "Run 'terraform fmt -recursive' to fix formatting issues"
        exit 1
      }

      # TFLint - fail only on errors (exit code 1), allow warnings (exit code 2)
      echo "Running tflint..."
      tflint --init || true
      
      # Temporarily disable pipefail to capture tflint exit code
      set +e
      tflint --format default
      TFLINT_EXIT_CODE=$?
      set -e
      
      if [ $TFLINT_EXIT_CODE -eq 1 ]; then
        echo "ERROR: tflint found errors"
        exit 1
      elif [ $TFLINT_EXIT_CODE -eq 2 ]; then
        echo "WARNING: tflint found warnings (non-blocking)"
      elif [ $TFLINT_EXIT_CODE -eq 0 ]; then
        echo "tflint passed with no issues"
      else
        echo "ERROR: tflint exited with unexpected code: $TFLINT_EXIT_CODE"
        exit 1
      fi
      
      echo "=========================================="
      echo "Lint completed successfully for $TARGET"
      echo "=========================================="

