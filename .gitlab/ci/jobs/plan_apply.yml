# ============================================
# Terraform Plan and Apply Jobs
# ============================================
# Handles terraform init, validate, plan, and apply
# ============================================

.terraform_plan_job:
  extends: 
    - .tf_init
  variables:
      # Fargate
    FARGATE_CLUSTER: "spot"
  script:
    - |
      #!/bin/bash
      set -euo pipefail
      
      echo "=========================================="
      echo "Running Terraform plan for $TARGET"
      echo "Environment: $ENVIRONMENT"
      echo "=========================================="
      
      # Configure Git for private Terraform modules
      if [ -n "${TF_MODULES_TOKEN:-}" ]; then
        echo "Configuring Git for private modules..."
        git config --global url."https://oauth2:$TF_MODULES_TOKEN@gitlab.com".insteadOf "https://gitlab.com" || true
        git config --global url."https://oauth2:$TF_MODULES_TOKEN@github.com".insteadOf "https://github.com" || true
      fi
      
      # Load environment-specific variables from root module path downwards
      # Format: root -> division -> current (current has highest precedence)
      VAR_FILES=""
      
      echo "Checking for terraform.tfvars files from root to current path..."
      echo "TARGET path: $TARGET"
      
      # 1. Root-level env (e.g., /env/dev/terraform.tfvars)
      ROOT_ENV_FILE="$CI_PROJECT_DIR/env/$ENVIRONMENT/terraform.tfvars"
      if [ -f "$ROOT_ENV_FILE" ]; then
        echo "✓ Found: env/$ENVIRONMENT/terraform.tfvars (root-level)"
        VAR_FILES="$VAR_FILES -var-file=$ROOT_ENV_FILE"
      else
        echo "  Not found: env/$ENVIRONMENT/terraform.tfvars"
      fi
      
      # 2. Division-level env (e.g., hli/infra/env/dev or services/storage-layer/env/dev)
      # Extract division path (first two path segments for hli/services)
      if echo "$TARGET" | grep -qE "^(hli|services)/"; then
        # Extract first two path segments (e.g., "hli/infra/vpc" -> "hli/infra")
        DIVISION_PATH=$(echo "$TARGET" | cut -d'/' -f1-2)
        DIVISION_ENV_FILE="$CI_PROJECT_DIR/$DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars"
        
        if [ -f "$DIVISION_ENV_FILE" ]; then
          echo "✓ Found: $DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars (division-level)"
          VAR_FILES="$VAR_FILES -var-file=$DIVISION_ENV_FILE"
        else
          echo "  Not found: $DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars"
        fi
      fi

      # 3. Current directory terraform.tfvars
      CURRENT_TFVARS="$CI_PROJECT_DIR/$TARGET/terraform.tfvars"
      if [ -f "$CURRENT_TFVARS" ]; then
        echo "✓ Found: $TARGET/terraform.tfvars (current directory)"
        VAR_FILES="$VAR_FILES -var-file=$CURRENT_TFVARS"
      else
        echo "  Not found: $TARGET/terraform.tfvars"
      fi

      # Validate VAR_FILES
      echo "VAR_FILES: $VAR_FILES"
      # Set environment variable for Terraform
      
      # Terraform plan
      echo "Running terraform plan..."
      terraform plan \
        -input=false \
        -no-color \
        -out="$TF_PLAN_FILE" \
        $VAR_FILES \
        2>&1 | tee plan.log || {
          echo "ERROR: terraform plan failed"
          exit 1
        }
      
      # Copy artifacts to a predictable location for GitLab
      # GitLab artifact paths are relative to the job working directory root
      mkdir -p "$CI_PROJECT_DIR/artifacts/$TARGET"
      cp "$TF_PLAN_FILE" "$CI_PROJECT_DIR/artifacts/$TARGET/" || echo "WARNING: Could not copy plan file"
      cp "$TF_PLAN_TEXT" "$CI_PROJECT_DIR/artifacts/$TARGET/" || echo "WARNING: Could not copy plan text"
      cp plan.log "$CI_PROJECT_DIR/artifacts/$TARGET/" || echo "WARNING: Could not copy plan log"
      
      echo "Artifacts copied to: $CI_PROJECT_DIR/artifacts/$TARGET/"
      ls -la "$CI_PROJECT_DIR/artifacts/$TARGET/" || true
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week

.terraform_apply_job:
  extends:
    - .tf_init
  variables:
    # Fargate
    FARGATE_CLUSTER: "ondemand"
  script:
    - |
      #!/bin/bash
      set -euo pipefail
      
      echo "=========================================="
      echo "Running Terraform apply for $TARGET"
      echo "Environment: $ENVIRONMENT"
      echo "=========================================="
      
      # Configure Git for private modules
      if [ -n "${TF_MODULES_TOKEN:-}" ]; then
        echo "Configuring Git for private modules..."
        git config --global url."https://oauth2:$TF_MODULES_TOKEN@gitlab.com".insteadOf "https://gitlab.com" || true
        git config --global url."https://oauth2:$TF_MODULES_TOKEN@github.com".insteadOf "https://github.com" || true
      fi

      # Load environment-specific variables from root module path downwards
      # Format: root -> division -> current (current has highest precedence)
      VAR_FILES=""
      
      echo "Checking for terraform.tfvars files from root to current path..."
      echo "TARGET path: $TARGET"
      
      # 1. Root-level env (e.g., /env/dev/terraform.tfvars)
      ROOT_ENV_FILE="$CI_PROJECT_DIR/env/$ENVIRONMENT/terraform.tfvars"
      if [ -f "$ROOT_ENV_FILE" ]; then
        echo "✓ Found: env/$ENVIRONMENT/terraform.tfvars (root-level)"
        VAR_FILES="$VAR_FILES -var-file=$ROOT_ENV_FILE"
      else
        echo "  Not found: env/$ENVIRONMENT/terraform.tfvars"
      fi
      
      # 2. Division-level env (e.g., hli/infra/env/dev or services/storage-layer/env/dev)
      # Extract division path (first two path segments for hli/services)
      if echo "$TARGET" | grep -qE "^(hli|services)/"; then
        # Extract first two path segments (e.g., "hli/infra/vpc" -> "hli/infra")
        DIVISION_PATH=$(echo "$TARGET" | cut -d'/' -f1-2)
        DIVISION_ENV_FILE="$CI_PROJECT_DIR/$DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars"
        
        if [ -f "$DIVISION_ENV_FILE" ]; then
          echo "✓ Found: $DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars (division-level)"
          VAR_FILES="$VAR_FILES -var-file=$DIVISION_ENV_FILE"
        else
          echo "  Not found: $DIVISION_PATH/env/$ENVIRONMENT/terraform.tfvars"
        fi
      fi

      # 3. Current directory terraform.tfvars
      CURRENT_TFVARS="$CI_PROJECT_DIR/$TARGET/terraform.tfvars"
      if [ -f "$CURRENT_TFVARS" ]; then
        echo "✓ Found: $TARGET/terraform.tfvars (current directory)"
        VAR_FILES="$VAR_FILES -var-file=$CURRENT_TFVARS"
      else
        echo "  Not found: $TARGET/terraform.tfvars"
      fi
      # Build terraform apply command with auto-approve
      TF_APPLY_CMD="terraform apply -no-color -auto-approve $VAR_FILES"
      
      # Terraform apply with auto-approve
      echo "Running terraform apply with auto-approve..."
      echo "Command: $TF_APPLY_CMD"
      $TF_APPLY_CMD 2>&1 | tee apply.log || {
        echo "ERROR: terraform apply failed"
        exit 1
      }
