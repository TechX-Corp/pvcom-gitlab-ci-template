# ============================================
# GitLab CI Pipeline for Terraform Data Mesh
# ============================================
# This pipeline follows the design document and reference pipeline patterns
# - CI runs on Pull Requests (plan only)
# - CD runs on merge to branch (apply)
# - Branch-based environments: dev, staging, production
# ============================================

include:
  - local: '.gitlab/ci/terraform-data-mesh.yml'

# Pipeline variables
variables:
  TERRAFORM_VERSION: "1.12.1"
  AWS_REGION: "${AWS_REGION:-ap-southeast-1}"
  TF_INPUT: "false"
  TF_IN_AUTOMATION: "true"
  TF_PLAN_FILE: "tfplan"
  TF_PLAN_TEXT: "plan.txt"
  
  # Git configuration for private modules
  GIT_STRATEGY: "clone"
  GIT_DEPTH: "0"

# Cache Terraform providers and modules
cache:
  key: "${CI_COMMIT_REF_SLUG}-terraform"
  paths:
    - .terraform/**/*
  policy: pull-push

# Stages definition
stages:
  - .pre      # Pre-stage for change detection
  - prepare   # Stage for child pipeline generation
  - lint
  - security
  - plan
  - approve
  - apply

# Workflow rules
workflow:
  rules:
    # Run CI pipeline on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        PIPELINE_MODE: "ci"
        # Use target branch name as environment (development, staging, production)
        ENVIRONMENT: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    
    # Run CD pipeline on push to main branches (development, staging, production)
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH =~ /^(development|staging|production)$/
      variables:
        PIPELINE_MODE: "cd"
        ENVIRONMENT: $CI_COMMIT_BRANCH
    
    # Run CD pipeline on push to main (defaults to development environment)
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        PIPELINE_MODE: "cd"
        ENVIRONMENT: "development"
    
    # Skip pipeline for other branches (optional - remove this rule to allow all branches)
    # - when: never

